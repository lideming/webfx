!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).webfx={})}(this,(function(t){"use strict";var e=this&&this.__awaiter||function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function r(t){try{l(s.next(t))}catch(t){o(t)}}function a(t){try{l(s.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}l((s=s.apply(t,e||[])).next())}))};const i=Object.assign,s=Object.prototype.hasOwnProperty;var n=new class{constructor(){this.fileSizeUnits=["B","KB","MB","GB"]}strPadLeft(t,e,i=" "){for(;t.length<e;)t=i+t;return t}formatTime(t){if("number"!=typeof t||isNaN(t))return"--:--";t=Math.round(t);var e=Math.floor(t/60);return t%=60,this.strPadLeft(e.toString(),2,"0")+":"+this.strPadLeft(t.toString(),2,"0")}formatFileSize(t){if("number"!=typeof t||isNaN(t))return"NaN";for(var e=0;e<this.fileSizeUnits.length-1&&t>=1024;)e++,t/=1024;return t.toFixed(2)+" "+this.fileSizeUnits[e]}formatDateTime(t){var e=new Date;return t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()&&t.getDate()===e.getDate()?t.toLocaleTimeString():t.toLocaleString()}numLimit(t,e,i){return t<e||"number"!=typeof t||isNaN(t)?e:t>i?i:t}createName(t,e){for(let i=0;;i++){let s=t(i);if(!e(s))return s}}base64EncodeUtf8(t){return btoa(encodeURIComponent(t).replace(/%([0-9A-F]{2})/g,(function(t,e){return String.fromCharCode("0x"+e)})))}sleepAsync(t){return new Promise(e=>{setTimeout(e,t)})}clearChildren(t){for(;t.lastChild;)t.removeChild(t.lastChild)}replaceChild(t,e){this.clearChildren(t),e&&t.appendChild(e)}toggleClass(t,e,i){var s=t.classList;return s.toggle?s.toggle(e,i):(void 0===i&&(i=!s.contains(e)),i?s.add(e):s.remove(e),i)}fadeout(t){t.classList.add("fading-out");var e=null,i=()=>{i&&(i=null,t.removeEventListener("transitionend",s),t.classList.remove("fading-out"),t.remove(),e&&e())},s=function(t){t.eventPhase===Event.AT_TARGET&&i()};return t.addEventListener("transitionend",s),setTimeout(i,350),{get finished(){return!i},onFinished(t){i?e=t:t()},cancel(){null==i||i()}}}listenPointerEvents(t,e){t.addEventListener("mousedown",(function(t){if("track"===e({type:"mouse",ev:t,point:t,action:"down"})){var i=function(t){e({type:"mouse",ev:t,point:t,action:"move"})},s=function(t){document.removeEventListener("mousemove",i,!0),document.removeEventListener("mouseup",s,!0),e({type:"mouse",ev:t,point:t,action:"up"})};document.addEventListener("mousemove",i,!0),document.addEventListener("mouseup",s,!0)}}));var i=!1;t.addEventListener("touchstart",(function(s){var n=s.changedTouches[0],o=e({type:"touch",touch:"start",ev:s,point:n,action:i?"move":"down"});if(!i&&"track"===o){i=!0;var r=function(t){var i=t.changedTouches[0];e({type:"touch",touch:"move",ev:t,point:i,action:"move"})},a=function(s){0===s.touches.length&&(i=!1,t.removeEventListener("touchmove",r),t.removeEventListener("touchend",a));var n=s.changedTouches[0];e({type:"touch",touch:"end",ev:s,point:n,action:i?"move":"up"})};t.addEventListener("touchmove",r),t.addEventListener("touchend",a)}}))}addEvent(t,e,i){return t.addEventListener(e,i),{remove:()=>t.removeEventListener(e,i)}}arrayRemove(t,e){for(let i=0;i<t.length;i++)t[i]===e&&(t.splice(i,1),i--)}arrayInsert(t,e,i){void 0===i?t.push(e):t.splice(i,0,e)}arrayMap(t,e){if(t instanceof Array)return t.map(e);var i=0,s=new Array(t.length);for(var n of t)s[i]=e(n,i),i++;return s}arrayForeach(t,e){var i=0;for(var s of t)e(s,i++)}arrayFind(t,e){if(t instanceof Array)return t.find(e);var i=0;for(var s of t)if(e(s,i++))return s;return null}arraySum(t,e){var i=0;return this.arrayForeach(t,t=>{var s=e(t);s&&(i+=s)}),i}objectApply(t,e,n){if(e){if(!n)return i(t,e);for(const i in e)if(s.call(e,i)&&(!n||n.indexOf(i)>=0)){const s=e[i];t[i]=s}}return t}mod(t,e){return t<0&&(t=e+t),t%e}readBlobAsDataUrl(t){return new Promise((e,i)=>{var s=new FileReader;s.onload=t=>{e(s.result)},s.onerror=t=>i(),s.readAsDataURL(t)})}};Array.prototype.remove=function(t){n.arrayRemove(this,t)};class o{constructor(t){this.callback=t,this.cancelFunc=void 0}timeout(t){this.tryCancel();var e=setTimeout(this.callback,t);this.cancelFunc=()=>window.clearTimeout(e)}interval(t){this.tryCancel();var e=setInterval(this.callback,t);this.cancelFunc=()=>window.clearInterval(e)}animationFrame(){this.tryCancel();var t=requestAnimationFrame(this.callback);this.cancelFunc=()=>cancelAnimationFrame(t)}tryCancel(){this.cancelFunc&&(this.cancelFunc(),this.cancelFunc=void 0)}}n.Timer=o;class r{constructor(t){this.dict=null!=t?t:{}}static EnsureCtx(t,e){var i;return i=t instanceof r?t:new r(t),e&&(e.actions||(e.actions=[]),i.actions=e.actions),i}setDict(t,e){this.dict||(this.dict={}),this.dict[t]=e}addUpdateAction(t){this.actions||(this.actions=[]),this.actions.push(t)}update(){if(this.actions)for(const t of this.actions)r.executeAction(t)}static executeAction(t){switch(t[0]){case"text":t[1].textContent=t[2]();break;case"hidden":t[1].hidden=t[2]();break;case"update":t[2](t[1]);break;default:console.warn("unknown action",t)}}}const a=n.buildDOM=(l=function(t,e,i){if(e--<0)throw new Error("ran out of TTL");if("string"==typeof t)return document.createTextNode(t);if(Node&&t instanceof Node)return t;if("getDOM"in t)return t.getDOM();const s=t.tag;if(!s)throw new Error("no tag");var n=function(t){for(var e,i,s=/[#\.^]?[\w\-]+/y;e=s.exec(t);){var n=e[0],o=n[0];if("."===o)i.classList.add(n.substr(1));else if("#"===o)i.id=n.substr(1);else{if(i)throw new Error("unexpected multiple tags");i=document.createElement(n)}}return i}(s);for(var o in t._ctx&&(i=r.EnsureCtx(t._ctx,i)),t){if(t.hasOwnProperty(o)){var a=t[o];"child"===o?a instanceof Array?a.forEach((function(t){n.appendChild(l(t,e,i))})):n.appendChild(l(a,e,i)):"_key"===o?i.setDict(a,n):"text"===o?"function"==typeof a?i.addUpdateAction(["text",n,a]):n.textContent=a:"hidden"===o&&"function"==typeof a?i.addUpdateAction(["hidden",n,a]):"update"===o&&"function"==typeof a?i.addUpdateAction(["update",n,a]):"init"===o||(n[o]=a)}const s=t.init;s&&s(n)}return n},function(t,e){return l(t,32,e)});var l;class h{constructor(t,e,i){if(this.onRender=null,this.key=t,!(e=this.type="string"==typeof e?h.types[e]:e)||!e.serialize||!e.deserialize)throw new Error("invalid 'type' arugment");this.readFromStorage(i)}readFromStorage(t){var e=this.key?localStorage.getItem(this.key):null;this.isInitial=!e,this.set(e?this.type.deserialize(e):t,!0)}render(t,e){e||t(this.data);const i=this.onRender,s=t;return i&&(t=function(t){i(t),s(t)}),this.onRender=t,this}bindToBtn(t,e){if(this.type!==h.types.bool)throw new Error("only for bool type");var i=document.createElement("span");t.insertBefore(i,t.firstChild),this.render((function(s){t.classList.toggle("disabled",!s),e=e||["❌","✅"],i.textContent=e[+s]}));var s=this;return t.addEventListener("click",(function(){s.toggle()})),this}remove(){localStorage.removeItem(this.key)}save(){this.isInitial=!1,localStorage.setItem(this.key,this.type.serialize(this.data))}set(t,e){this.data=t,this.isInitial=!1,this.onRender&&this.onRender(t),!e&&this.key&&this.save()}get(){return this.data}toggle(){if(this.type!==h.types.bool)throw new Error("only for bool type");this.set(!this.data)}loop(t){var e=this.data,i=t.findIndex((function(t){return t===e})),s=t[(i+1)%t.length];this.set(s)}}h.types={bool:{serialize:function(t){return t?"true":"false"},deserialize:function(t){return"true"===t||"false"!==t&&void 0}},str:{serialize:function(t){return t},deserialize:function(t){return t}},json:{serialize:function(t){return JSON.stringify(t)},deserialize:function(t){return JSON.parse(t)}}};class d{constructor(){this.list=null}invoke(...t){this.list&&this.list.forEach(e=>e.apply(this,t))}add(t){return this.list||(this.list=[]),this.list.push(t),t}remove(t){this.list&&this.list.remove(t)}}class c{constructor(){this.data={},this.curLang="en",this.missing=new Map}get(t,e){return this.get2(t,e)||t}get2(t,e,i){i=i||this.curLang;var s=this.data[i];if(!s)return console.log("i18n missing lang: "+i),null;var n=s[t];if(!n)return this.missing.has(t)||(this.missing.set(t,1),console.log("i18n missing key: "+t)),null;if(e)for(const t in e)if(e.hasOwnProperty(t)){const i=e[t];n=n.replace("{"+t+"}",i)}return n}add2dArray(t){const e=[],i=t[0];for(const t of i)e.push(this.data[t]=this.data[t]||{});for(let i=1;i<t.length;i++){const s=t[i],n=s[0];for(let t=0;t<s.length;t++){const i=s[t];e[t][n]=i}}}renderElements(t){console.log("i18n elements rendering"),t.forEach(t=>{for(const i of t.childNodes)if(i.nodeType===Node.TEXT_NODE){var e=this.get2(i.beforeI18n||i.textContent);e?(i.beforeI18n=i.beforeI18n||i.textContent,i.textContent=e):(i.beforeI18n&&(i.textContent=i.beforeI18n),console.log("missing key for node",i))}})}static detectLanguage(t){var e=null,i=-1,s=[];return(navigator.languages||[navigator.language]).forEach(t=>{s.push(t),t.indexOf("-")>0&&s.push(t.substr(0,t.indexOf("-")))}),t.forEach(t=>{var n=s.indexOf(t);(!e||-1!==n&&n<i)&&(e=t,i=n)}),e||t[0]}}function u(t){var e=new WeakMap;return function(i,...s){if(0===s.length)return t.get(i[0]);let n=e.get(i);if(void 0===n){n="";for(let t=0;t<i.length;t++){n+=i[t],t<s.length&&(n+="{"+t+"}")}e.set(i,n)}for(var o=t.get(n),r=0;r<s.length;r++)o=o.replace("{"+r+"}",s[r]);return o}}var v=new c;const m=u(v);var p=this&&this.__awaiter||function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function r(t){try{l(s.next(t))}catch(t){o(t)}}function a(t){try{l(s.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}l((s=s.apply(t,e||[])).next())}))};class g{constructor(t){this.parentView=void 0,this._position=void 0,this.domctx=new r,this._dom=void 0,this._onactive=void 0,this._onActiveCbs=void 0,t&&this.domExprCreated(t)}static getView(t){return t instanceof g?t:new g(t)}get position(){return this._position}get domCreated(){return!!this._dom}get dom(){return this.ensureDom(),this._dom}get hidden(){return this.dom.hidden}set hidden(t){this.dom.hidden=t}ensureDom(){if(!this._dom){var t=this.createDom();this.domExprCreated(t)}}domExprCreated(t){this._dom=n.buildDOM(t,this.domctx),this.postCreateDom(),this.updateDom()}createDom(){return document.createElement("div")}postCreateDom(){}updateDom(){this.domctx.update()}updateWith(t){n.objectApply(this,t),this.updateDom()}toggleClass(t,e){n.toggleClass(this.dom,t,e)}appendView(t){return this.dom.appendView(t)}getDOM(){return this.dom}get onactive(){return this._onactive}set onactive(t){!!this._onactive!=!!t&&(t?(this._onActiveCbs=[t=>{this._onactive()},t=>{this.handleKeyDown(t,this._onactive)}],this.dom.addEventListener("click",this._onActiveCbs[0]),this.dom.addEventListener("keydown",this._onActiveCbs[1])):(this.dom.removeEventListener("click",this._onActiveCbs[0]),this.dom.removeEventListener("keydown",this._onActiveCbs[1]),this._onActiveCbs=void 0)),this._onactive=t}handleKeyDown(t,e){"Enter"===t.code&&(e(),t.preventDefault())}}HTMLElement.prototype.getDOM=function(){return this},Node.prototype.appendView=function(t){this.appendChild(t.dom)};class f extends g{constructor(){super(...arguments),this.items=[]}appendView(t){this.addView(t)}addView(t,e){var i;const s=this.items;if(t.parentView)throw new Error("the view is already in a container view");if(t.parentView=this,void 0===e)t._position=s.length,s.push(t),this.dom.appendChild(t.dom);else{s.splice(e,0,t),this.dom.insertBefore(t.dom,(null===(i=s[e+1])||void 0===i?void 0:i.dom)||null);for(let t=e;t<s.length;t++)s[t]._position=t}}removeView(t){(t=this._ensureItem(t)).dom.remove();var e=t._position;t.parentView=t._position=void 0,this.items.splice(e,1);for(let t=e;t<this.items.length;t++)this.items[t]._position=t}removeAllView(){for(;this.length;)this.removeView(this.length-1)}updateChildrenDom(){for(const t of this.items)t.updateDom()}_ensureItem(t){if("number"==typeof t)t=this.items[t];else{if(!t)throw new Error("item is null or undefined.");if(t.parentView!==this)throw new Error("the item is not in this listview.")}return t}[Symbol.iterator](){return this.items[Symbol.iterator]()}get length(){return this.items.length}get(t){return this.items[t]}map(t){return n.arrayMap(this,t)}find(t){return n.arrayFind(this,t)}forEach(t){return n.arrayForeach(this,t)}}var w=new class{constructor(){this._currentItem=null,this._currentArray=null,this.onDragStart=new d,this.onDragEnd=new d}get currentItem(){var t,e,i;return null!==(i=null!==(t=this._currentItem)&&void 0!==t?t:null===(e=this._currentArray)||void 0===e?void 0:e[0])&&void 0!==i?i:null}get currentArray(){return this._currentItem?[this._currentItem]:this._currentArray}start(t){this._currentItem=t,console.log("drag start",t),this.onDragStart.invoke()}startArray(t){this._currentArray=t,console.log("drag start array",t),this.onDragStart.invoke()}end(){this._currentItem=null,this._currentArray=null,console.log("drag end"),this.onDragEnd.invoke()}};class y extends g{constructor(){super(...arguments),this.dragging=void 0,this._selected=!1,this.onSelectedChanged=new d,this.enterctr=0,this.dragoverPlaceholder=null}get listview(){return this.parentView}get selectionHelper(){return this.listview.selectionHelper}get dragData(){return this.dom.textContent}get selected(){return this._selected}set selected(t){this._selected=t,this.domCreated&&this.updateDom(),this.onSelectedChanged.invoke()}remove(){this.listview&&this.listview.remove(this)}postCreateDom(){super.postCreateDom(),this.dom.setAttribute("role","listitem"),this.dom.addEventListener("click",t=>{var e,i,s;(null===(e=this.listview)||void 0===e?void 0:e.selectionHelper.handleItemClicked(this,t))||null===(s=null===(i=this.listview)||void 0===i?void 0:i.onItemClicked)||void 0===s||s.call(i,this)}),this.dom.addEventListener("keydown",t=>{var e,i,s,n,o,r;if("Enter"===t.code){if(t.altKey){const t=this.dom.getBoundingClientRect(),n=new MouseEvent("contextmenu",{clientX:t.left,clientY:t.top,relatedTarget:this.dom});null===(s=null!==(e=this.onContextMenu)&&void 0!==e?e:null===(i=this.listview)||void 0===i?void 0:i.onContextMenu)||void 0===s||s(this,n)}else{if(null===(n=this.listview)||void 0===n?void 0:n.selectionHelper.handleItemClicked(this,t))return;null===(r=null===(o=this.listview)||void 0===o?void 0:o.onItemClicked)||void 0===r||r.call(o,this)}t.preventDefault()}else if(this.listview&&("ArrowUp"===t.code||"ArrowDown"===t.code)){var a="ArrowUp"===t.code?-1:1,l=this.listview.get(this.position+a);l&&(l.dom.focus(),t.preventDefault())}}),this.dom.addEventListener("contextmenu",t=>{var e,i,s;null===(s=null!==(e=this.onContextMenu)&&void 0!==e?e:null===(i=this.listview)||void 0===i?void 0:i.onContextMenu)||void 0===s||s(this,t)}),this.dom.addEventListener("dragstart",t=>{var e,i;if(null!==(e=this.dragging)&&void 0!==e?e:null===(i=this.listview)||void 0===i?void 0:i.dragging){var s=[];this.selected?(s=[...this.selectionHelper.selectedItems]).sort((t,e)=>t.position-e.position):s=[this],w.startArray(s),t.dataTransfer.setData("text/plain",s.map(t=>t.dragData).join("\r\n")),s.forEach(t=>t.dom.style.opacity=".5")}else t.preventDefault()}),this.dom.addEventListener("dragend",t=>{var e=w.currentArray;w.end(),t.preventDefault(),e.forEach(t=>t.dom.style.opacity="")}),this.dom.addEventListener("dragover",t=>{this.dragHandler(t,"dragover")}),this.dom.addEventListener("dragenter",t=>{this.dragHandler(t,"dragenter")}),this.dom.addEventListener("dragleave",t=>{this.dragHandler(t,"dragleave")}),this.dom.addEventListener("drop",t=>{this.dragHandler(t,"drop")})}dragHandler(t,e){var i,s,o,r,a,l,h,d;const c=w.currentItem;let u=w.currentArray;const v="drop"===e,m={source:c,target:this,sourceItems:u,event:t,drop:v,accept:!1};if(c instanceof y&&(null===(i=this.listview)||void 0===i?void 0:i.moveByDragging)&&c.listview===this.listview){t.preventDefault();const e=u.indexOf(this)>=0,i=t.clientY-this.dom.getBoundingClientRect().top>this.dom.offsetHeight/2;if(e&&v||(m.accept=i?"move-after":"move"),v){if(-1===u.indexOf(this)){let t=this.position;i&&t++;for(const e of u)e!==this&&(t>e.position&&t--,this.listview.move(e,t),t++)}}else t.dataTransfer.dropEffect="move"}const p=null!==(s=this.onDragover)&&void 0!==s?s:null===(o=this.listview)||void 0===o?void 0:o.onDragover;!m.accept&&p&&(p(m),(v||m.accept)&&t.preventDefault());const g=null!==(r=this.onContextMenu)&&void 0!==r?r:null===(a=this.listview)||void 0===a?void 0:a.onContextMenu;if(!m.accept&&c===this&&g&&(v?g(this,t):t.preventDefault()),"dragenter"===e||"dragover"==e||"dragleave"===e||v){"dragenter"===e?this.enterctr++:"dragleave"===e?this.enterctr--:"drop"===e&&(this.enterctr=0);let t=this.enterctr>0;this.toggleClass("dragover",t);let i=t&&("move"===m.accept||"move-after"===m.accept)&&m.accept;if(i!=(null!==(h=null===(l=this.dragoverPlaceholder)||void 0===l?void 0:l[1])&&void 0!==h&&h)&&(null===(d=this.dragoverPlaceholder)||void 0===d||d[0].remove(),this.dragoverPlaceholder=null,i)){this.dragoverPlaceholder=[n.buildDOM({tag:"div.dragover-placeholder"}),i];var f=this.dom;"move-after"===m.accept&&(f=f.nextElementSibling),this.dom.parentElement.insertBefore(this.dragoverPlaceholder[0],f)}}}}class C extends f{constructor(t){super(t),this.onItemClicked=null,this.dragging=!1,this.moveByDragging=!1,this.selectionHelper=new x,this.onItemMoved=null,this.onDragover=null,this.onContextMenu=null,this.selectionHelper.itemProvider=this.get.bind(this)}postCreateDom(){super.postCreateDom(),this.dom.setAttribute("role","list")}add(t,e){this.addView(t,e),this.dragging&&(t.dom.draggable=!0)}remove(t,e){t=this._ensureItem(t),!e&&t.selected&&this.selectionHelper.toggleItemSelection(t),this.removeView(t)}move(t,e){var i;t=this._ensureItem(t),this.remove(t,!0),this.add(t,e),null===(i=this.onItemMoved)||void 0===i||i.call(this,t,t.position)}removeAll(){for(;this.length;)this.remove(this.length-1)}clear(){this.removeAll(),n.clearChildren(this.dom)}ReplaceChild(t){this.clear(),this.dom.appendChild(t.getDOM())}}class x{constructor(){this._enabled=!1,this.onEnabledChanged=new d,this.itemProvider=null,this.ctrlForceSelect=!1,this.selectedItems=[],this.onSelectedItemsChanged=new d,this.lastToggledItem=null}get enabled(){return this._enabled}set enabled(t){if(!!t!=!!this._enabled){for(this._enabled=t;this.selectedItems.length;)this.toggleItemSelection(this.selectedItems[0],!1);this.lastToggledItem=null,this.onEnabledChanged.invoke()}}get count(){return this.selectedItems.length}handleItemClicked(t,e){if(!this.enabled){if(!this.ctrlForceSelect||!e.ctrlKey)return!1;this.enabled=!0}if(e.shiftKey&&this.lastToggledItem&&this.itemProvider){var i=!!this.lastToggledItem.selected,s=t.position,n=this.lastToggledItem.position;s>n&&([s,n]=[n,s]);for(let t=s;t<=n;t++)this.toggleItemSelection(this.itemProvider(t),i);this.lastToggledItem=t}else this.toggleItemSelection(t);return!0}toggleItemSelection(t,e){void 0!==e&&e===!!t.selected||(t.selected?(t.selected=!1,this.selectedItems.remove(t),this.onSelectedItemsChanged.invoke("remove",t)):(t.selected=!0,this.selectedItems.push(t),this.onSelectedItemsChanged.invoke("add",t)),this.lastToggledItem=t,0===this.count&&this.ctrlForceSelect&&(this.enabled=!1))}}class b extends g{createDom(){return{tag:"div.overlay"}}setCenterChild(t){return this.toggleClass("centerchild",t),this}setNoBg(t){return this.toggleClass("nobg",t),this}}class D extends y{constructor(t){super(),this.text="",this.cls="normal",this.onclick=null,n.objectApply(this,t)}createDom(){return{tag:"div.item.no-selection",tabIndex:0}}postCreateDom(){super.postCreateDom(),this.onactive=()=>{var t;this.parentView instanceof _&&(this.parentView.keepOpen||this.parentView.close()),null===(t=this.onclick)||void 0===t||t.call(this)}}updateDom(){this.dom.textContent=this.text,this.cls!==this._lastcls&&(this._lastcls&&this.dom.classList.remove(this._lastcls),this.cls&&this.dom.classList.add(this.cls))}}class _ extends C{constructor(t){super({tag:"div.context-menu",tabIndex:0}),this.keepOpen=!1,this.useOverlay=!0,this._visible=!1,this.overlay=null,this._onclose=null,this._originalFocused=null,null==t||t.forEach(t=>this.add(t))}get visible(){return this._visible}show(t){"ev"in t&&(t={x:t.ev.pageX,y:t.ev.pageY}),this.close(),this._visible=!0,this.useOverlay?(this.overlay||(this.overlay=new b,this.overlay.dom.style.background="rgba(0, 0, 0, .1)",this.overlay.dom.addEventListener("mousedown",t=>{t.eventPhase===Event.AT_TARGET&&(t.preventDefault(),this.close())})),this.overlay.appendView(this),document.body.appendChild(this.overlay.dom)):document.body.appendChild(this.dom),this._originalFocused=document.activeElement,this.dom.focus();var e=t=>{!this.dom.contains(t.relatedTarget)&&this.close()},i=t=>{"Escape"===t.code&&(t.preventDefault(),this.close())};this.dom.addEventListener("focusout",e),this.dom.addEventListener("keydown",i),this._onclose=()=>{this.dom.removeEventListener("focusout",e),this.dom.removeEventListener("keydown",i)};var s=this.dom.offsetWidth,n=this.dom.offsetHeight;t.x+s>document.body.offsetWidth&&(t.x-=s),t.y+n>document.body.offsetHeight&&(t.y-=n),t.x<0&&(t.x=0),t.y<0&&(t.y=0),this.dom.style.left=t.x+"px",this.dom.style.top=t.y+"px"}close(){var t,e,i;this._visible&&(this._visible=!1,null===(t=this._onclose)||void 0===t||t.call(this),this._onclose=null,null===(i=null===(e=this._originalFocused)||void 0===e?void 0:e.focus)||void 0===i||i.call(e),this._originalFocused=null,this.overlay&&n.fadeout(this.overlay.dom),n.fadeout(this.dom))}}class E extends g{constructor(){super(),this.content=new f({tag:"div.dialog-content"}),this.shown=!1,this.btnTitle=new I({active:!0,clickable:!1}),this.btnClose=new I({text:m`Close`,right:!0}),this.title="Dialog",this.allowClose=!0,this.showCloseButton=!0,this.onShown=new d,this.onClose=new d,this.focusTrap=new g({tag:"div.focustrap",tabIndex:0}),this.btnClose.onClick.add(()=>this.allowClose&&this.close())}get width(){return this.dom.style.width}set width(t){this.dom.style.width=t}get contentFlex(){return this.content.dom.classList.contains("flex")}set contentFlex(t){this.content.toggleClass("flex",!!t)}get resizable(){return this.dom.classList.contains("resize")}set resizable(t){this.toggleClass("resize",!!t)}createDom(){return{_ctx:this,_key:"dialog",tag:"div.dialog",tabIndex:0,style:"width: 300px",child:[{_key:"domheader",tag:"div.dialog-title",child:[{tag:"div",style:"clear: both;"}]},this.content,this.focusTrap]}}postCreateDom(){super.postCreateDom(),this.addBtn(this.btnTitle),this.addBtn(this.btnClose),this.overlay=(new b).setCenterChild(!0).setNoBg(!0),this.overlay.dom.appendView(this),this.overlay.dom.addEventListener("mousedown",t=>{this.allowClose&&0===t.button&&t.target===this.overlay.dom&&(t.preventDefault(),this.close())}),this.overlay.dom.addEventListener("keydown",t=>{if(this.allowClose&&27===t.keyCode)t.preventDefault(),this.close();else if(t.target===this.dom&&"Tab"===t.code&&t.shiftKey){t.preventDefault();let e=this.dom.querySelectorAll("a, [tabindex]");e.length>=2&&e[e.length-2].focus&&e[e.length-2].focus()}});{let t;n.listenPointerEvents(this.domheader,e=>{if("down"===e.action){if(e.ev.target!==this.domheader&&e.ev.target!==this.btnTitle.dom)return;e.ev.preventDefault();const i=this.overlay.dom.getBoundingClientRect(),s=this.dom.getBoundingClientRect();return t={x:e.point.pageX-i.x-s.x,y:e.point.pageY-i.y-s.y},"track"}if("move"===e.action){e.ev.preventDefault();const i=this.overlay.dom.getBoundingClientRect(),s=n.numLimit(e.point.pageX,i.left,i.right),o=n.numLimit(e.point.pageY,i.top,i.bottom);this.setOffset(s-t.x,o-t.y)}})}this.dom.addEventListener("resize",()=>{this.dom.style.width&&(this.width=this.dom.style.width)}),this.focusTrap.dom.addEventListener("focus",t=>{this.dom.focus()})}updateDom(){this.btnTitle.updateWith({text:this.title}),this.btnTitle.hidden=!this.title,this.btnClose.hidden=!(this.allowClose&&this.showCloseButton)}addBtn(t){this.ensureDom(),this.domheader.insertBefore(t.dom,this.domheader.lastChild)}addContent(t,e){this.ensureDom(),e&&this.content.removeAllView(),this.content.appendView(g.getView(t))}setOffset(t,e){this.dom.style.left=t?t+"px":"",this.dom.style.top=e?e+"px":"",this.overlay.setCenterChild(!1)}getOffset(){return{x:this.dom.style.left?parseFloat(this.dom.style.left):0,y:this.dom.style.top?parseFloat(this.dom.style.top):0}}center(){this.setOffset(0,0),this.overlay.setCenterChild(!0)}show(){var t;this.shown||(this.shown=!0,null===(t=this._cancelFadeout)||void 0===t||t.call(this),this.ensureDom(),E.defaultParent.onDialogShowing(this),this.dom.focus(),(this.autoFocus||this).dom.focus(),this.onShown.invoke())}close(){this.shown&&(this.shown=!1,this.onClose.invoke(),this._cancelFadeout=n.fadeout(this.overlay.dom).cancel,E.defaultParent.onDialogClosing(this))}waitClose(){return new Promise(t=>{var e=this.onClose.add(()=>{this.onClose.remove(e),t()})})}}class I extends g{constructor(t){super(),this.text="",this.clickable=!0,this.active=!1,this.right=!1,this.onclick=null,this.onClick=new d,n.objectApply(this,t)}createDom(){return{tag:"span.tab.no-selection"}}postCreateDom(){this.onactive=()=>{var t;null===(t=this.onclick)||void 0===t||t.call(this),this.onClick.invoke()}}updateDom(){this.dom.textContent=this.text,this.dom.tabIndex=this.clickable?0:-1,this.toggleClass("clickable",this.clickable),this.toggleClass("active",this.active),this.dom.style.float=this.right?"right":"left"}}class k extends g{constructor(t){super(),this.multiline=!1,this.type="text",this.placeholder="",n.objectApply(this,t)}get value(){return this.dom.value}set value(t){this.dom.value=t}createDom(){return this.multiline?{tag:"textarea.input-text"}:{tag:"input.input-text"}}updateDom(){super.updateDom(),this.dom instanceof HTMLInputElement&&(this.dom.type=this.type,this.dom.placeholder=this.placeholder)}}class A extends g{get text(){return this.dom.textContent}set text(t){this.dom.textContent=t}}class L extends g{constructor(){super(...arguments),this.parentDom=null,this.toasts=[]}createDom(){return{tag:"div.toasts-container"}}addToast(t){0===this.toasts.length&&this.show(),this.toasts.push(t)}removeToast(t){this.toasts.remove(t),0===this.toasts.length&&this.remove()}show(){(this.parentDom||document.body).appendChild(this.dom)}remove(){this.dom.remove()}}L.default=new L;class T extends g{constructor(t){super(),this.text="",this.shown=!1,this.timer=new o(()=>this.close()),n.objectApply(this,t),this.container||(this.container=L.default)}show(t){this.shown||(this.container.addToast(this),this.container.appendView(this),this.shown=!0),t?this.timer.timeout(t):this.timer.tryCancel()}close(){this.shown&&(this.shown=!1,n.fadeout(this.dom).onFinished(()=>this.container.removeToast(this)))}createDom(){return{tag:"div.toast"}}updateDom(){this.dom.textContent=this.text}static show(t,e){var i=new T({text:t});return i.show(e),i}}t.BuildDOMCtx=r,t.ButtonView=class extends A{constructor(t){super(),this.disabled=!1,this.type="normal",n.objectApply(this,t),this.updateDom()}get onclick(){return this.onactive}set onclick(t){this.onactive=t}createDom(){return{tag:"div.btn",tabIndex:0}}updateDom(){super.updateDom(),this.toggleClass("disabled",this.disabled),this.toggleClass("btn-big","big"===this.type)}},t.Callbacks=d,t.CancelToken=class{constructor(){this.cancelled=!1,this.onCancelled=new d}cancel(){this.cancelled||(this.cancelled=!0,this.onCancelled.invoke())}throwIfCancelled(){if(this.cancelled)throw new Error("operation cancelled.")}},t.ContainerView=f,t.ContextMenu=_,t.DataUpdatingHelper=class{update(t){const e=this.items;var i={};for(const e of t)i[this.dataSelectId(e)]=e;var s={},n=[];for(const t of e){const e=this.selectId(t);void 0!==i[e]?s[e]=t:n.push(t)}for(let t=n.length-1;t>=0;t--)this.removeItem(n[t]);var o=0;for(const e of t){const t=s[this.dataSelectId(e)];void 0!==t?this.updateItem(t,e):this.addItem(e,o),o++}}selectId(t){return t.id}dataSelectId(t){return t.id}addItem(t,e){}updateItem(t,e){}removeItem(t){}},t.Dialog=E,t.DialogParent=class extends g{constructor(t){super(null!=t?t:document.body),this.bgOverlay=new b,this.dialogCount=0,this._cancelFadeout=null}onDialogShowing(t){var e;0==this.dialogCount++&&(null===(e=this._cancelFadeout)||void 0===e||e.call(this),this.appendView(this.bgOverlay)),this.appendView(t.overlay)}onDialogClosing(t){0==--this.dialogCount&&(this._cancelFadeout=n.fadeout(this.bgOverlay.dom).cancel)}},t.EditableHelper=class{constructor(t){this.editing=!1,this.beforeEdit=null,this.onComplete=null,this.element=t}startEdit(t){if(!this.editing){this.editing=!0;var e=this.element,i=this.beforeEdit=e.textContent;n.toggleClass(e,"editing",!0);for(var s=n.buildDOM({tag:"input",type:"text",value:i});e.firstChild;)e.removeChild(e.firstChild);e.appendChild(s),s.select(),s.focus();var o=()=>{var i;this.editing=!1,n.toggleClass(e,"editing",!1),r.forEach(t=>t.remove()),s.remove(),null===(i=this.onComplete)||void 0===i||i.call(this,s.value),null==t||t(s.value)},r=[n.addEvent(s,"keydown",t=>{"Enter"===t.code&&(o(),t.preventDefault())}),n.addEvent(s,"focusout",t=>{o()})]}}startEditAsync(){return new Promise(t=>this.startEdit(t))}},t.EventRegistrations=class{constructor(){this.list=[]}add(t,e){return this.list.push({event:t,func:e}),t.add(e),e}removeAll(){for(;this.list.length;){var t=this.list.pop();t.event.remove(t.func)}}},t.I=m,t.I18n=c,t.InputView=k,t.ItemActiveHelper=class{constructor(t){this.funcSetActive=(t,e)=>t.toggleClass("active",e),this.current=null,n.objectApply(this,t)}set(t){this.current!==t&&(this.current&&this.funcSetActive(this.current,!1),this.current=t,this.current&&this.funcSetActive(this.current,!0))}},t.LabeledInput=class extends g{constructor(t){super(),this.label="",this.type="text",this.input=new k,n.objectApply(this,t)}get dominput(){return this.input.dom}get value(){return this.dominput.value}set value(t){this.dominput.value=t}createDom(){return{_ctx:this,tag:"div.labeled-input",child:[{tag:"div.input-label",text:()=>this.label},this.input]}}updateDom(){super.updateDom(),this.input.type=this.type,this.input.domCreated&&this.input.updateDom()}},t.Lazy=class{constructor(t){this._func=t,this._value=void 0}get computed(){return!this._func}get rawValue(){return this._value}get value(){return this._func&&(this._value=this._func(),this._func=void 0),this._value}},t.ListView=C,t.ListViewItem=y,t.LoadingIndicator=class extends g{constructor(t){super(),this._status="running",this.onclick=null,t&&n.objectApply(this,t)}get state(){return this._status}set state(t){this._status=t,["running","error","normal"].forEach(e=>this.toggleClass(e,t===e))}get content(){return this._text}set content(t){this._text=t,this.ensureDom(),this._textdom.textContent=t}reset(){this.state="running",this.content=m`Loading`,this.onclick=null}error(t,e){this.state="error",this.content=m`Oh no! Something just goes wrong:`+"\r\n"+t,e&&(this.content+="\r\n"+m`[Click here to retry]`),this.onclick=e}action(t){return p(this,void 0,void 0,(function*(){try{yield t()}catch(e){this.error(e,()=>this.action(t))}}))}createDom(){return{_ctx:this,tag:"div.loading-indicator",child:[{tag:"div.loading-indicator-inner",child:[{tag:"div.loading-indicator-text",_key:"_textdom"}]}],onclick:t=>this.onclick&&this.onclick(t)}}postCreateDom(){this.reset()}},t.MenuInfoItem=class extends D{constructor(t){super(t),this.text="",n.objectApply(this,t)}createDom(){return{tag:"div.menu-info"}}updateDom(){super.updateDom(),this.dom.textContent=this.text}},t.MenuItem=D,t.MenuLinkItem=class extends D{constructor(t){super(t),this.link="",this.download="",n.objectApply(this,t)}createDom(){var t=super.createDom();return t.tag="a.item.no-selection",t.target="_blank",t}updateDom(){super.updateDom(),this.dom.href=this.link,this.dom.download=this.download}},t.MessageBox=class extends E{constructor(){super(...arguments),this.allowClose=!1,this.title="Message",this.result="none"}addResultBtns(t){for(const e of t)this.addBtnWithResult(new I({text:v.get("msgbox_"+e),right:!0}),e);return this}setTitle(t){return this.title=t,this.domCreated&&this.updateDom(),this}addText(t){return this.addContent(new A({tag:"div.messagebox-text",textContent:t})),this}allowCloseWithResult(t,e){return this.result=t,this.allowClose=!0,this.showCloseButton=!!e,this.domCreated&&this.updateDom(),this}addBtnWithResult(t,e){return t.onClick.add(()=>{this.result=e,this.close()}),this.addBtn(t),this}showAndWaitResult(){return p(this,void 0,void 0,(function*(){return this.show(),yield this.waitClose(),this.result}))}},t.Overlay=b,t.Section=class extends g{constructor(t){super(),this.titleView=new A({tag:"span.section-title"}),this.headerView=new g({tag:"div.section-header",child:[this.titleView]}),this.ensureDom(),t&&(t.title&&this.setTitle(t.title),t.content&&this.setContent(t.content),t.actions&&t.actions.forEach(t=>this.addAction(t)))}createDom(){return{_ctx:this,tag:"div.section",child:[this.headerView]}}setTitle(t){this.titleView.text=t}setContent(t){for(var e=this.dom,i=e.firstChild;e.lastChild!==i;)e.removeChild(e.lastChild);e.appendChild(t.getDOM())}addAction(t){var e=new g({tag:"div.section-action.clickable",text:t.text,tabIndex:0});e.onactive=t.onclick,this.headerView.dom.appendChild(e.dom)}},t.SelectionHelper=x,t.Semaphore=class{constructor(t){this.queue=new Array,this.maxCount=1,this.runningCount=0,n.objectApply(this,t)}enter(){if(this.runningCount===this.maxCount){var t,e=new Promise(e=>{t=e});return this.queue.push(t),e}return this.runningCount++,Promise.resolve()}exit(){this.runningCount===this.maxCount&&this.queue.length?window.queueMicrotask?window.queueMicrotask(this.queue.shift()):setTimeout(this.queue.shift(),0):this.runningCount--}run(t){return e(this,void 0,void 0,(function*(){yield this.enter();try{yield t()}finally{this.exit()}}))}},t.SettingItem=h,t.TabBtn=I,t.TextCompositionWatcher=class{constructor(t){this.isCompositing=!1,this.dom=t.getDOM(),this.dom.addEventListener("compositionstart",t=>{this.isCompositing=!0}),this.dom.addEventListener("compositionend",t=>{this.isCompositing=!1})}},t.TextView=A,t.Timer=o,t.Toast=T,t.ToastsContainer=L,t.View=g,t.buildDOM=a,t.createStringBuilder=u,t.dragManager=w,t.i18n=v,t.utils=n,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=webfx.min.js.map
